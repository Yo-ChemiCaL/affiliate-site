---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProductCard from '../../components/ProductCard.astro';
import type { Product } from '../../components/ProductCard.astro';
import { url } from '../../lib/url';
import { fromCategorySlug, toCategorySlug } from '../../lib/category';
import productsData from '../../data/products.json';

export async function getStaticPaths() {
  const products = productsData as Product[];
  // è‹±èªslugã§ä¸€æ„ãªã‚«ãƒ†ã‚´ãƒªä¸€è¦§
  const slugSet = new Set(products.map((p) => (p as any).categorySlug ?? toCategorySlug(p.category)));

  return [...slugSet].map((slug) => ({
    params: { name: slug },
    props: {
      categorySlug: slug,
      categoryName: fromCategorySlug(slug),
      products: products.filter((p) => ((p as any).categorySlug ?? toCategorySlug(p.category)) === slug),
    },
  }));
}

interface Props {
  categorySlug: string;
  categoryName: string;
  products: Product[];
}

const { categorySlug, categoryName, products } = Astro.props;
const allProducts = productsData as Product[];
const allSlugs = [...new Set(allProducts.map((p) => (p as any).categorySlug ?? toCategorySlug(p.category)))];
const sorted = [...products].sort(
  (a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime()
);

// ã“ã®ã‚«ãƒ†ã‚´ãƒªã«é–¢é€£ã™ã‚‹bestè¨˜äº‹ã‚’æ¢ã™
const bestFiles = await Astro.glob('../../data/best/*.json');
const relatedBest = bestFiles
  .map((f) => f.default)
  .filter((b) => b.categorySlug === categorySlug);
---

<BaseLayout
  title={`${categoryName}ã®ãŠã™ã™ã‚å•†å“ä¸€è¦§ | mono-lab`}
  description={`${categoryName}ã‚«ãƒ†ã‚´ãƒªã®ãŠã™ã™ã‚å•†å“${products.length}ä»¶ã‚’å³é¸ç´¹ä»‹ã€‚æ¯”è¼ƒãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚‚æ²è¼‰ã€‚`}
>
  <div class="container page-content">
    <nav class="breadcrumb" aria-label="ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ">
      <ol>
        <li><a href={url('/')}>ãƒ›ãƒ¼ãƒ </a></li>
        <li><a href={url('/category/')}>ã‚«ãƒ†ã‚´ãƒª</a></li>
        <li aria-current="page">{categoryName}</li>
      </ol>
    </nav>

    <div class="page-header">
      <h1 class="page-title">{categoryName}</h1>
      <p class="page-count">{products.length}ä»¶ã®å•†å“</p>
    </div>

    <!-- é–¢é€£bestè¨˜äº‹ -->
    {relatedBest.length > 0 && (
      <div class="related-best">
        <p class="related-label">ğŸ“Š æ¯”è¼ƒè¨˜äº‹ã‹ã‚‰é¸ã¶</p>
        {relatedBest.map((b) => (
          <a href={url(`/best/${b.slug}/`)} class="best-link-card">
            <span class="best-link-title">{b.title}</span>
            <span class="best-link-cta">æ¯”è¼ƒè¡¨ã‚’è¦‹ã‚‹ â†’</span>
          </a>
        ))}
      </div>
    )}

    <!-- ä»–ã‚«ãƒ†ã‚´ãƒª -->
    <div class="other-categories">
      <span class="other-label">ä»–ã®ã‚«ãƒ†ã‚´ãƒª:</span>
      {allSlugs.filter((s) => s !== categorySlug).map((slug) => (
        <a href={url(`/category/${slug}/`)} class="category-chip">
          {fromCategorySlug(slug)}
        </a>
      ))}
    </div>

    <!-- å•†å“ä¸€è¦§ -->
    {sorted.length > 0 ? (
      <div class="product-grid">
        {sorted.map((product) => <ProductCard product={product} />)}
      </div>
    ) : (
      <div class="empty-state">
        <p>ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯ã¾ã å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        <a href={url('/')} class="btn-back">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a>
      </div>
    )}

    <!-- ä¸‹éƒ¨å°ç·š -->
    <div class="bottom-nav">
      <a href={url('/best/')} class="nav-btn">ğŸ“Š æ¯”è¼ƒè¨˜äº‹ä¸€è¦§</a>
      <a href={url('/pick/')} class="nav-btn">âš¡ å³æ±ºã‚¬ã‚¤ãƒ‰ä¸€è¦§</a>
      <a href={url('/')} class="nav-btn">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</a>
    </div>
  </div>
</BaseLayout>

<style>
  .page-content { padding-top: 24px; padding-bottom: 48px; }

  .breadcrumb ol { display: flex; list-style: none; gap: 8px; font-size: 0.82rem; color: var(--color-text-muted); flex-wrap: wrap; margin-bottom: 24px; }
  .breadcrumb li:not(:last-child)::after { content: 'â€º'; margin-left: 8px; color: var(--color-border); }
  .breadcrumb a { color: var(--color-primary); }

  .page-header { display: flex; align-items: baseline; gap: 16px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 3px solid var(--color-primary); }
  .page-title { font-size: 1.6rem; font-weight: 900; }
  .page-count { font-size: 0.9rem; color: var(--color-text-muted); }

  .related-best { margin-bottom: 20px; }
  .related-label { font-size: 0.82rem; font-weight: 700; color: var(--color-text-muted); margin-bottom: 8px; }
  .best-link-card { display: flex; justify-content: space-between; align-items: center; background: #fffbf0; border: 2px solid var(--color-accent); border-radius: var(--radius); padding: 14px 18px; margin-bottom: 8px; transition: all var(--transition); }
  .best-link-card:hover { background: var(--color-accent); color: #333; }
  .best-link-title { font-size: 0.9rem; font-weight: 700; color: var(--color-text); }
  .best-link-cta { font-size: 0.82rem; font-weight: 700; color: var(--color-primary); white-space: nowrap; }

  .other-categories { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
  .other-label { font-size: 0.82rem; color: var(--color-text-muted); font-weight: 600; }
  .category-chip { display: inline-block; padding: 4px 12px; background-color: var(--color-bg); border: 1px solid var(--color-border); border-radius: 16px; font-size: 0.8rem; color: var(--color-text); transition: all var(--transition); }
  .category-chip:hover { border-color: var(--color-primary); color: var(--color-primary); }

  .empty-state { text-align: center; padding: 64px 0; color: var(--color-text-muted); }
  .btn-back { display: inline-block; margin-top: 16px; padding: 10px 24px; background-color: var(--color-primary); color: #fff; border-radius: var(--radius); font-weight: 700; }

  .bottom-nav { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 40px; padding-top: 24px; border-top: 1px solid var(--color-border); }
  .nav-btn { padding: 10px 18px; border: 2px solid var(--color-border); border-radius: var(--radius); font-size: 0.85rem; font-weight: 600; color: var(--color-text); transition: all var(--transition); }
  .nav-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
</style>
