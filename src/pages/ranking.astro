---
import BaseLayout from '../layouts/BaseLayout.astro';
import type { Product } from '../components/ProductCard.astro';
import { url } from '../lib/url';
import productsData from '../data/products.json';

const products = (productsData as any[]).filter((p) => !p.draft) as Product[];

// „É©„É≥„Ç≠„É≥„Ç∞„Çπ„Ç≥„Ç¢: Ë©ï‰æ° √ó log(„É¨„Éì„É•„ÉºÊï∞)
const ranked = [...products]
  .map((p) => ({
    ...p,
    score: p.rating * Math.log10(p.reviewCount + 1),
  }))
  .sort((a, b) => b.score - a.score);

// „Ç´„ÉÜ„Ç¥„É™ÊÉÖÂ†±„ÇícategorySlug„ÅßÈõÜÁ¥ÑÔºàÂá∫ÁèæÈ†Ü„Çí‰øùÊåÅÔºâ
const categoryMap = products.reduce<Record<string, { name: string; slug: string }>>((acc, p) => {
  const slug = (p as any).categorySlug;
  if (slug && !acc[slug]) acc[slug] = { name: p.category, slug };
  return acc;
}, {});

// „Ç´„ÉÜ„Ç¥„É™Âà•„É©„É≥„Ç≠„É≥„Ç∞ÔºàÂÖ®ÂïÜÂìÅ„Çí„Çπ„Ç≥„Ç¢È†ÜÔºâ
const categoryRankings = Object.values(categoryMap).map(({ name, slug }) => ({
  name,
  slug,
  products: ranked.filter((p) => (p as any).categorySlug === slug),
}));
---

<BaseLayout
  title="„Éá„Çπ„ÇØ„Ç¨„Ç∏„Çß„ÉÉ„Éà „Ç´„ÉÜ„Ç¥„É™Âà•„É©„É≥„Ç≠„É≥„Ç∞ | mono-lab"
  description="Ë©ï‰æ°„Éª„É¨„Éì„É•„ÉºÊï∞„Çí„ÇÇ„Å®„Å´ÁÆóÂá∫„Åó„Åü„Éá„Çπ„ÇØ„Ç¨„Ç∏„Çß„ÉÉ„Éà„ÅÆ„Ç´„ÉÜ„Ç¥„É™Âà•„Åä„Åô„Åô„ÇÅ„É©„É≥„Ç≠„É≥„Ç∞„ÄÇ„É¢„Éã„Çø„Éº„ÉªÂÖ•Âäõ„Éá„Éê„Ç§„Çπ„ÉªÁÖßÊòé„Éª„Éè„ÉñÂà•„Å´Êé≤Ëºâ„ÄÇ"
>
  <div class="container page-content">
    <h1 class="page-title">„Ç´„ÉÜ„Ç¥„É™Âà•„É©„É≥„Ç≠„É≥„Ç∞</h1>
    <p class="page-desc">Ë©ï‰æ°ÁÇπÊï∞„Å®„É¨„Éì„É•„ÉºÊï∞„Çí„ÇÇ„Å®„Å´ÁÆóÂá∫„Åó„Åü„Ç´„ÉÜ„Ç¥„É™Âà•„Åä„Åô„Åô„ÇÅÈ†Ü‰Ωç„Åß„Åô„ÄÇ</p>

    <!-- „Ç´„ÉÜ„Ç¥„É™„Ç∏„É£„É≥„Éó„Éä„Éì -->
    <nav class="cat-nav" aria-label="„Ç´„ÉÜ„Ç¥„É™‰∏ÄË¶ß">
      {categoryRankings.map(({ name, slug }) => (
        <a href={`#${slug}`} class="cat-nav-link">{name}</a>
      ))}
    </nav>

    <!-- „Ç´„ÉÜ„Ç¥„É™Âà•„É©„É≥„Ç≠„É≥„Ç∞ -->
    {categoryRankings.map(({ name, slug, products: items }) => (
      <section class="category-section" id={slug}>
        <div class="category-section-head">
          <h2 class="category-section-title">
            <a href={url(`/category/${slug}/`)}>{name}</a>
          </h2>
          <a href={url(`/category/${slug}/`)} class="see-all-link">ÂÖ®ÂïÜÂìÅ„ÇíË¶ã„Çã ‚Üí</a>
        </div>

        <ol class="ranking-list">
          {items.map((product, i) => {
            const stars = '‚òÖ'.repeat(Math.round(product.rating)) + '‚òÜ'.repeat(5 - Math.round(product.rating));
            const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : null;
            const discount = product.originalPrice && product.price
              ? Math.round((1 - product.price / product.originalPrice) * 100)
              : null;
            return (
              <li class="ranking-item">
                <span class={`rank-number ${i < 3 ? `rank-top${i + 1}` : ''}`}>
                  {medal ?? i + 1}
                </span>
                <div class="rank-info">
                  <a href={url(`/products/${product.slug}/`)} class="rank-title">{product.title}</a>
                  {(product as any).scene && (
                    <span class="rank-scene">{(product as any).scene}</span>
                  )}
                  <div class="rank-meta">
                    <span class="stars">{stars}</span>
                    <span class="rating">{product.rating}</span>
                    <span class="review-count">({product.reviewCount.toLocaleString()}‰ª∂)</span>
                    {product.price && <span class="price">¬•{product.price.toLocaleString()}</span>}
                    {discount && <span class="off-badge">{discount}%OFF</span>}
                  </div>
                </div>
                <div class="rank-actions">
                  {(product as any).pickSlug && (
                    <a href={url(`/pick/${(product as any).pickSlug}/`)} class="btn-pick-now">
                      ‰ªä„Åô„ÅêÈÅ∏„Å∂
                    </a>
                  )}
                  {product.amazonUrl && (
                    <a
                      href={product.amazonUrl}
                      class="btn-affiliate btn-amazon"
                      target="_blank"
                      rel="noopener noreferrer nofollow"
                    >
                      Amazon
                    </a>
                  )}
                </div>
              </li>
            );
          })}
        </ol>
      </section>
    ))}
  </div>
</BaseLayout>

<style>
  .page-content {
    padding-top: 40px;
    padding-bottom: 64px;
  }

  .page-title {
    font-size: 1.8rem;
    font-weight: 900;
    margin-bottom: 8px;
  }

  .page-desc {
    color: var(--color-text-muted);
    font-size: 0.95rem;
    margin-bottom: 28px;
  }

  /* „Ç´„ÉÜ„Ç¥„É™„Ç∏„É£„É≥„Éó„Éä„Éì */
  .cat-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 48px;
    padding: 16px 20px;
    background: var(--color-card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  .cat-nav-link {
    display: inline-block;
    padding: 6px 14px;
    background: var(--color-bg);
    border: 2px solid var(--color-border);
    border-radius: 20px;
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--color-text);
    transition: all var(--transition);
  }

  .cat-nav-link:hover {
    border-color: var(--color-primary);
    background: var(--color-primary);
    color: #fff;
  }

  /* „Ç´„ÉÜ„Ç¥„É™„Çª„ÇØ„Ç∑„Éß„É≥ */
  .category-section {
    margin-bottom: 56px;
    scroll-margin-top: 80px;
  }

  .category-section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 3px solid var(--color-primary);
  }

  .category-section-title {
    font-size: 1.25rem;
    font-weight: 800;
  }

  .category-section-title a {
    color: var(--color-text);
    transition: color var(--transition);
  }

  .category-section-title a:hover {
    color: var(--color-primary);
  }

  .see-all-link {
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--color-primary);
    white-space: nowrap;
  }

  /* „É©„É≥„Ç≠„É≥„Ç∞„É™„Çπ„Éà */
  .ranking-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .ranking-item {
    display: grid;
    grid-template-columns: 48px 1fr auto;
    align-items: center;
    gap: 16px;
    background: var(--color-card);
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
    border-left: 4px solid transparent;
    transition: box-shadow var(--transition), border-color var(--transition);
  }

  .ranking-item:nth-child(1) { border-left-color: #FFD700; }
  .ranking-item:nth-child(2) { border-left-color: #C0C0C0; }
  .ranking-item:nth-child(3) { border-left-color: #CD7F32; }

  .ranking-item:hover {
    box-shadow: var(--shadow-hover);
  }

  .rank-number {
    font-size: 1.5rem;
    font-weight: 900;
    text-align: center;
    color: var(--color-text-muted);
    line-height: 1;
  }

  .rank-top1 { font-size: 1.6rem; }
  .rank-top2 { font-size: 1.5rem; }
  .rank-top3 { font-size: 1.4rem; }

  .rank-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 0;
  }

  .rank-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--color-text);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    transition: color var(--transition);
  }

  .rank-title:hover {
    color: var(--color-primary);
  }

  .rank-scene {
    font-size: 0.72rem;
    color: var(--color-primary);
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .rank-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .stars {
    color: var(--color-accent);
    font-size: 0.75rem;
  }

  .rating {
    font-weight: 700;
    font-size: 0.85rem;
  }

  .review-count {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .price {
    font-size: 0.9rem;
    font-weight: 700;
    color: #e63946;
  }

  .off-badge {
    font-size: 0.7rem;
    font-weight: 700;
    background: #e63946;
    color: #fff;
    padding: 2px 6px;
    border-radius: 3px;
  }

  .rank-actions {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .btn-pick-now {
    display: inline-block;
    padding: 8px 14px;
    background: var(--color-primary);
    color: #fff;
    border-radius: var(--radius);
    font-size: 0.78rem;
    font-weight: 700;
    white-space: nowrap;
    text-align: center;
    transition: all var(--transition);
  }

  .btn-pick-now:hover {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
    color: #fff;
  }

  .rank-actions .btn-affiliate {
    padding: 8px 14px;
    font-size: 0.78rem;
    white-space: nowrap;
  }

  @media (max-width: 640px) {
    .ranking-item {
      grid-template-columns: 40px 1fr;
    }
    .rank-actions { display: none; }
    .rank-number { font-size: 1.2rem; }
  }
</style>
