---
import BaseLayout from '../layouts/BaseLayout.astro';
import ProductCard from '../components/ProductCard.astro';
import type { Product } from '../components/ProductCard.astro';
import { url } from '../lib/url';
import { toCategorySlug } from '../lib/category';
import productsData from '../data/products.json';

const products = productsData as Product[];

// ── Quick Picks 選定 ─────────────────────────────────────────────────────────
// 選定基準:
//   1. rating >= 4.1 かつ reviewCount >= 300 でフィルタ（購買信頼性の最低ライン）
//   2. rating 降順でソート（最高評価を優先）
//   3. categorySlug 重複なし（先着1件）で最大3件採用（シーン多様性を確保）
const QP_RATING_MIN = 4.1;
const QP_REVIEW_MIN = 300;
const _seenCats = new Set<string>();
const quickPicks = [...products]
  .filter((p) => p.rating >= QP_RATING_MIN && p.reviewCount >= QP_REVIEW_MIN)
  .sort((a, b) => b.rating - a.rating)
  .filter((p) => {
    const slug = (p as any).categorySlug ?? toCategorySlug(p.category);
    if (_seenCats.has(slug)) return false;
    _seenCats.add(slug);
    return true;
  })
  .slice(0, 3);

// ── 注目商品 ─────────────────────────────────────────────────────────────────
const featuredProducts = products.filter((p) => p.featured);

// ── カテゴリ一覧（英語slug） ─────────────────────────────────────────────────
const categoryMap = products.reduce<Record<string, { name: string; slug: string; count: number }>>((acc, p) => {
  const slug = (p as any).categorySlug ?? toCategorySlug(p.category);
  if (!acc[slug]) acc[slug] = { name: p.category, slug, count: 0 };
  acc[slug].count++;
  return acc;
}, {});
const categories = Object.values(categoryMap);

// ── 最新レビュー（比較記事） ─────────────────────────────────────────────────
const bestFiles = await Astro.glob('../data/best/*.json');
const bestArticles = bestFiles.map((f) => f.default).slice(0, 3);
---

<BaseLayout
  title="mono-lab | 用途別・比較で選ぶ購入ガイド"
  description="テレワーク・通勤・充電など用途別に商品を比較。購入直前の迷いをゼロにする商品選びガイド。"
>
  <!-- Hero -->
  <section class="hero">
    <div class="container">
      <h1 class="hero-title">用途から選ぶ。比較して、すぐ買う。</h1>
      <p class="hero-subtitle">購入直前の迷いをゼロにする商品選びガイド</p>
      <div class="hero-actions">
        <a href={url('/ranking/')} class="btn-hero-primary">比較から探す →</a>
        <a href="#quick-picks" class="btn-hero-secondary">今すぐ選ぶ →</a>
      </div>
    </div>
  </section>

  <!-- Quick Picks -->
  <section class="section section-light" id="quick-picks">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title">今すぐ選ぶ — シーン別ベスト1</h2>
      </div>
      <div class="qp-grid">
        {quickPicks.map((p) => {
          const discount = p.originalPrice && p.price
            ? Math.round((1 - p.price / p.originalPrice) * 100)
            : null;
          return (
            <div class="qp-card">
              <div class="qp-image">
                <img src={p.image} alt={p.title} loading="eager" width="300" height="200" />
                {discount && <span class="qp-off">{discount}%OFF</span>}
              </div>
              <div class="qp-body">
                <span class="qp-scene">{(p as any).scene}</span>
                <p class="qp-title">{p.title}</p>
                <ul class="qp-points">
                  <li class="qp-strength">✅ {(p as any).strength}</li>
                  <li class="qp-caution">⚠️ {(p as any).caution}</li>
                </ul>
                {p.price && <p class="qp-price">¥{p.price.toLocaleString()}</p>}
                <a href={url(`/pick/${(p as any).pickSlug}/`)} class="btn-qp-pick">
                  今すぐ選ぶ →
                </a>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </section>

  <!-- 比較入口バナー -->
  <div class="compare-entry-banner">
    <div class="container">
      <div class="compare-entry-inner">
        <p class="compare-entry-text">もっと比べてから選びたい方は</p>
        <a href={url('/ranking/')} class="btn-compare-entry">比較から探す →</a>
      </div>
    </div>
  </div>

  <!-- 用途別カテゴリ -->
  <section class="section">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title">用途別で探す</h2>
        <a href={url('/category/')} class="see-all">一覧を見る →</a>
      </div>
      <div class="category-list">
        {categories.map((cat) => (
          <a href={url(`/category/${cat.slug}/`)} class="category-badge">
            {cat.name} ({cat.count})
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- 注目商品 -->
  {featuredProducts.length > 0 && (
    <section class="section section-light">
      <div class="container">
        <div class="section-head">
          <h2 class="section-title">★ 注目商品</h2>
        </div>
        <div class="product-grid">
          {featuredProducts.map((product) => <ProductCard product={product} />)}
        </div>
      </div>
    </section>
  )}

  <!-- 最新レビュー -->
  <section class="section">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title">最新レビュー</h2>
        <a href={url('/best/')} class="see-all">すべて見る →</a>
      </div>
      <div class="review-list">
        {bestArticles.map((article) => (
          <a href={url(`/best/${article.slug}/`)} class="review-card">
            <div class="review-card-body">
              <span class="review-category">{article.category}</span>
              <h3 class="review-title">{article.title}</h3>
              <p class="review-desc">{article.description}</p>
            </div>
            <span class="review-link-btn">比較を見る →</span>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- アフィリエイト表記 -->
  <div class="container">
    <p class="disclosure">
      ※ 当サイトはAmazonアソシエイト・プログラムに参加しています。商品リンクから購入いただいた場合、サイト運営者が報酬を受け取ることがあります。
    </p>
  </div>
</BaseLayout>

<style>
  /* ── Hero ──────────────────────────────────────────────────────── */
  .hero {
    background: linear-gradient(135deg, var(--color-secondary) 0%, #2d2d5e 100%);
    color: #fff;
    padding: 64px 0 56px;
    text-align: center;
  }
  .hero-title {
    font-size: clamp(1.5rem, 4vw, 2.4rem);
    font-weight: 900;
    line-height: 1.3;
    margin-bottom: 12px;
  }
  .hero-subtitle {
    color: rgba(255,255,255,0.75);
    margin-bottom: 32px;
    font-size: 1rem;
  }
  .hero-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .btn-hero-primary {
    display: inline-block;
    padding: 14px 28px;
    background: var(--color-primary);
    color: #fff;
    border-radius: var(--radius);
    font-weight: 700;
    font-size: 1rem;
    transition: all var(--transition);
  }
  .btn-hero-primary:hover { background: var(--color-primary-dark); transform: translateY(-1px); }
  .btn-hero-secondary {
    display: inline-block;
    padding: 14px 28px;
    border: 2px solid rgba(255,255,255,0.6);
    color: #fff;
    border-radius: var(--radius);
    font-weight: 700;
    font-size: 1rem;
    transition: all var(--transition);
  }
  .btn-hero-secondary:hover { border-color: #fff; background: rgba(255,255,255,0.1); }

  /* ── Section 共通 ───────────────────────────────────────────────── */
  .section { padding: 48px 0; }
  .section-light { background: #fff; }
  .section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }
  .section-title { font-size: 1.3rem; font-weight: 800; }
  .see-all { font-size: 0.85rem; font-weight: 700; color: var(--color-primary); }

  /* ── Quick Picks ────────────────────────────────────────────────── */
  .qp-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 20px;
  }
  .qp-card {
    background: var(--color-card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    border: 2px solid transparent;
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  .qp-card:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-hover);
  }
  .qp-image {
    position: relative;
    aspect-ratio: 3/2;
    overflow: hidden;
    background: #f5f5f5;
  }
  .qp-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 8px;
  }
  .qp-off {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #e63946;
    color: #fff;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 4px;
  }
  .qp-body {
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
  }
  .qp-scene {
    display: inline-block;
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--color-primary);
    background: #fff4ef;
    padding: 3px 8px;
    border-radius: 3px;
    align-self: flex-start;
  }
  .qp-title {
    font-size: 0.88rem;
    font-weight: 800;
    line-height: 1.4;
  }
  .qp-points {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .qp-points li { font-size: 0.8rem; line-height: 1.5; }
  .qp-caution { color: var(--color-text-muted); }
  .qp-price {
    font-size: 1.2rem;
    font-weight: 900;
    color: #e63946;
  }
  .btn-qp-cta {
    display: block;
    text-align: center;
    padding: 10px;
    font-size: 0.88rem;
    margin-top: auto;
  }
  .btn-qp-pick {
    display: block;
    text-align: center;
    padding: 11px 10px;
    font-size: 0.88rem;
    font-weight: 700;
    background: var(--color-primary);
    color: #fff;
    border-radius: var(--radius);
    margin-top: auto;
    transition: all var(--transition);
  }
  .btn-qp-pick:hover { background: var(--color-primary-dark); transform: translateY(-1px); color: #fff; }

  /* ── 比較入口バナー ──────────────────────────────────────────────── */
  .compare-entry-banner {
    background: #fff4ef;
    padding: 18px 0;
    border-top: 1px solid #fbd5c0;
    border-bottom: 1px solid #fbd5c0;
  }
  .compare-entry-inner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  .compare-entry-text {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--color-text);
  }
  .btn-compare-entry {
    display: inline-block;
    padding: 10px 24px;
    background: var(--color-primary);
    color: #fff;
    border-radius: var(--radius);
    font-weight: 700;
    font-size: 0.9rem;
    transition: all var(--transition);
  }
  .btn-compare-entry:hover { background: var(--color-primary-dark); transform: translateY(-1px); }

  /* ── 用途別カテゴリ ──────────────────────────────────────────────── */
  .category-list { display: flex; flex-wrap: wrap; gap: 10px; }
  .category-badge {
    display: inline-block;
    padding: 8px 16px;
    background-color: var(--color-bg);
    border: 2px solid var(--color-border);
    border-radius: 24px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-text);
    transition: all var(--transition);
  }
  .category-badge:hover {
    border-color: var(--color-primary);
    background-color: var(--color-primary);
    color: #fff;
  }

  /* ── 最新レビュー ────────────────────────────────────────────────── */
  .review-list { display: flex; flex-direction: column; gap: 12px; }
  .review-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    background: var(--color-card);
    border-radius: var(--radius);
    padding: 20px 24px;
    box-shadow: var(--shadow);
    color: var(--color-text);
    transition: box-shadow var(--transition), transform var(--transition);
  }
  .review-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-1px); }
  .review-category {
    font-size: 0.7rem;
    color: var(--color-primary);
    font-weight: 700;
    text-transform: uppercase;
    display: block;
    margin-bottom: 4px;
  }
  .review-title { font-size: 0.95rem; font-weight: 800; margin-bottom: 4px; line-height: 1.4; }
  .review-desc { font-size: 0.8rem; color: var(--color-text-muted); line-height: 1.5; }
  .review-link-btn {
    white-space: nowrap;
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--color-primary);
    padding: 8px 14px;
    border: 2px solid var(--color-primary);
    border-radius: var(--radius);
    transition: all var(--transition);
  }
  .review-card:hover .review-link-btn { background: var(--color-primary); color: #fff; }

  /* ── アフィリエイト表記 ──────────────────────────────────────────── */
  .disclosure {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    padding: 16px 0 32px;
    line-height: 1.6;
  }

  @media (max-width: 600px) {
    .review-card { flex-direction: column; align-items: flex-start; }
  }
</style>
