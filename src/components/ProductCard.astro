---
import { url } from '../lib/url';

export interface Product {
  slug: string;
  title: string;
  description: string;
  image: string;
  category: string;
  tags: string[];
  rating: number;       // 1-5
  reviewCount: number;
  price?: number;
  originalPrice?: number;
  amazonUrl?: string;
  a8Url?: string;
  featured?: boolean;
  publishedAt: string;
  updatedAt?: string;
}

interface Props {
  product: Product;
}

const { product } = Astro.props;
const discount = product.originalPrice && product.price
  ? Math.round((1 - product.price / product.originalPrice) * 100)
  : null;
const stars = '★'.repeat(Math.round(product.rating)) + '☆'.repeat(5 - Math.round(product.rating));
---

<article class="product-card">
  <a href={url(`/products/${product.slug}/`)} class="card-image-link">
    <div class="card-image">
      <img src={product.image} alt={product.title} loading="lazy" width="300" height="200" />
      {product.featured && <span class="badge badge-featured">注目</span>}
      {discount && <span class="badge badge-discount">-{discount}%</span>}
    </div>
  </a>
  <div class="card-body">
    <span class="card-category">{product.category}</span>
    <h2 class="card-title">
      <a href={url(`/products/${product.slug}/`)}>{product.title}</a>
    </h2>
    <p class="card-description">{product.description}</p>
    <div class="card-rating" title={`${product.rating}点 (${product.reviewCount}件)`}>
      <span class="stars">{stars}</span>
      <span class="rating-count">({product.reviewCount})</span>
    </div>
    {product.price && (
      <div class="card-price">
        {product.originalPrice && (
          <span class="original-price">¥{product.originalPrice.toLocaleString()}</span>
        )}
        <span class="current-price">¥{product.price.toLocaleString()}</span>
      </div>
    )}
    <div class="card-actions">
      {product.amazonUrl && (
        <a href={product.amazonUrl} class="btn-affiliate btn-amazon" target="_blank" rel="noopener noreferrer nofollow">
          Amazonで見る
        </a>
      )}
      {product.a8Url && (
        <a href={product.a8Url} class="btn-affiliate btn-a8" target="_blank" rel="noopener noreferrer nofollow">
          公式サイトで見る
        </a>
      )}
    </div>
  </div>
</article>

<style>
  .product-card {
    background: var(--color-card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    transition: box-shadow var(--transition), transform var(--transition);
    display: flex;
    flex-direction: column;
  }

  .product-card:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
  }

  .card-image-link {
    display: block;
  }

  .card-image {
    position: relative;
    aspect-ratio: 3 / 2;
    overflow: hidden;
    background: #f0f0f0;
  }

  .card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .product-card:hover .card-image img {
    transform: scale(1.03);
  }

  .badge {
    position: absolute;
    top: 8px;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    z-index: 1;
  }

  .badge-featured {
    left: 8px;
    background-color: var(--color-primary);
    color: #fff;
  }

  .badge-discount {
    right: 8px;
    background-color: #e63946;
    color: #fff;
  }

  .card-body {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
  }

  .card-category {
    font-size: 0.72rem;
    color: var(--color-primary);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .card-title {
    font-size: 0.95rem;
    font-weight: 700;
    line-height: 1.4;
  }

  .card-title a {
    color: var(--color-text);
  }

  .card-title a:hover {
    color: var(--color-primary);
  }

  .card-description {
    font-size: 0.82rem;
    color: var(--color-text-muted);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-rating {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .stars {
    color: var(--color-accent);
    font-size: 0.85rem;
    letter-spacing: 1px;
  }

  .rating-count {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .card-price {
    display: flex;
    align-items: baseline;
    gap: 8px;
  }

  .original-price {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    text-decoration: line-through;
  }

  .current-price {
    font-size: 1.1rem;
    font-weight: 700;
    color: #e63946;
  }

  .card-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: auto;
    padding-top: 8px;
  }
</style>
